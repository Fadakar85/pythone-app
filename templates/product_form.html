{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-8">
        <div class="card signuper mb-4">
            <div class="card-header" style="background: var(--dark-green);">
                <h4 class="mb-0">{% if product %}ویرایش محصول{% else %}محصول جدید{% endif %}</h4>
            </div>
            <div class="card-body bg-very-black">
                <!-- فرم بدون جاوا اسکریپت -->
                <form method="POST" enctype="multipart/form-data" id="productForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">نام محصول</label>
                        <input type="text" class="inputs" placeholder="نام محصول را وارد کنید" id="name" name="name" 
                               value="{{ product.name if product else '' }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">توضیحات</label>
                        <textarea class="inputs" placeholder="توضیحات راجب محصول و ویژگی های آن..." id="description" name="description" rows="3">{{ product.description if product else '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">قیمت (تومان)</label>
                        <input type="number" class="inputs" placeholder="قیمت محصول را وارد کنید" id="price" name="price" 
                               value="{{ product.price if product else '' }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="category_id" class="form-label">دسته‌بندی</label>
                        <select class="form-select" id="category_id" name="category_id" required>
                            <option value="">انتخاب دسته‌بندی</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if product and product.category_id == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="province" class="form-label">استان</label>
                        <select class="form-select" id="province" name="province" required>
                            <option value="">انتخاب استان</option>
                            {% for province in provinces %}
                            <option value="{{ province }}" {% if product and product.address.split('-')[0] == province %}selected{% endif %}>
                                {{ province }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="city" class="form-label">شهر</label>
                        <select class="form-select" id="city" name="city" required>
                            <option value="">انتخاب شهر</option>
                            {% if product %}
                                {% for city in citiesByProvince[product.address.split('-')[0]] %}
                                <option value="{{ city }}" {% if product.address.split('-')[1] == city %}selected{% endif %}>
                                    {{ city }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="postal_code" class="form-label">کد پستی</label>
                        <input type="text" class="inputs" placeholder="کد پستی محل فروش (اختیاری)" id="postal_code" name="postal_code" 
                               value="{{ product.postal_code if product else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="product_type" class="form-label">نوع محصول</label>
                        <select class="form-select" id="product_type" name="product_type" required>
                            <option value="NEW" {% if product and product.product_type.name == "NEW" %}selected{% endif %}>نو</option>
                            <option value="STOCK" {% if product and product.product_type.name == "STOCK" %}selected{% endif %}>استوک</option>
                            <option value="USED" {% if product and product.product_type.name == "USED" %}selected{% endif %}>دست دوم</option>
                            <option value="NEEDS_REPAIR" {% if product and product.product_type.name == "NEEDS_REPAIR" %}selected{% endif %}>نیاز به تعمیر جزئی</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="image" class="form-label">تصویر محصول</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                        {% if product and product.image_path %}
                        <div class="mt-2">
                            <img src="{{ url_for('static', filename='uploads/' + product.image_path) }}" 
                                 alt="تصویر فعلی" class="img-thumbnail" style="max-height: 200px;">
                        </div>
                        {% endif %}
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn header-tabs py-3">
                            {% if product %}به‌روزرسانی محصول{% else %}ایجاد محصول{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    // لیست شهرهای مربوط به هر استان
    const citiesByProvince = {
    "آذربایجان شرقی": [
        "تبریز",
        "اسکو",
        "اهر",
        "بستان‌آباد",
        "بناب",
        "جلفا",
        "چاراویماق",
        "خداآفرین",
        "سراب",
        "شبستر",
        "عجب‌شیر",
        "کلیبر",
        "مراغه",
        "مرند",
        "ملکان",
        "میانه",
        "ورزقان",
        "هریس",
        "هشترود"
    ],
    "آذربایجان غربی": [
        "ارومیه",
        "اشنویه",
        "بوکان",
        "پلدشت",
        "پیرانشهر",
        "تکاب",
        "چالدران",
        "چایپاره",
        "خوی",
        "سردشت",
        "سلماس",
        "شاهین‌دژ",
        "شوط",
        "ماکو",
        "مهاباد",
        "میاندوآب",
        "نقده"
    ],
    "اردبیل": [
        "اردبیل",
        "بیله‌سوار",
        "پارس‌آباد",
        "خلخال",
        "سرعین",
        "کوثر",
        "گرمی",
        "مشگین‌شهر",
        "نمین",
        "نیر"
    ],
    "اصفهان": [
        "اصفهان",
        "آران و بیدگل",
        "اردستان",
        "برخوار",
        "بوئین و میاندشت",
        "تیران و کرون",
        "چادگان",
        "خمینی‌شهر",
        "خوانسار",
        "خور و بیابانک",
        "دهاقان",
        "سمیرم",
        "شاهین‌شهر و میمه",
        "شهرضا",
        "فریدن",
        "فریدون‌شهر",
        "فلاورجان",
        "کاشان",
        "گلپایگان",
        "لنجان",
        "مبارکه",
        "نائین",
        "نجف‌آباد",
        "نطنز"
    ],
    "البرز": [
        "کرج",
        "اشتهارد",
        "ساوجبلاغ",
        "طالقان",
        "فردیس",
        "نظرآباد"
    ],
    "ایلام": [
        "ایلام",
        "آبدانان",
        "ایوان",
        "بدره",
        "چرداول",
        "دره‌شهر",
        "دهلران",
        "سیروان",
        "ملکشاهی",
        "مهران"
    ],
    "بوشهر": [
        "بوشهر",
        "تنگستان",
        "جم",
        "دشتستان",
        "دشتی",
        "دیر",
        "دیلم",
        "کنگان",
        "گناوه"
    ],
    "تهران": [
        "تهران",
        "اسلامشهر",
        "بهارستان",
        "پاکدشت",
        "پردیس",
        "پیشوا",
        "دماوند",
        "رباط‌کریم",
        "ری",
        "شمیرانات",
        "شهریار",
        "فیروزکوه",
        "قدس",
        "قرچک",
        "ملارد",
        "ورامین"
    ],
    "چهارمحال و بختیاری": [
        "شهرکرد",
        "اردل",
        "بروجن",
        "بن",
        "سامان",
        "فارسان",
        "کوهرنگ",
        "کیار",
        "لردگان"
    ],
    "خراسان جنوبی": [
        "بیرجند",
        "بشرویه",
        "خوسف",
        "درمیان",
        "زیرکوه",
        "سرایان",
        "سربیشه",
        "طبس",
        "فردوس",
        "قائنات",
        "نهبندان"
    ],
    "خراسان رضوی": [
        "مشهد",
        "بردسکن",
        "بجستان",
        "تایباد",
        "تربت جام",
        "تربت حیدریه",
        "چناران",
        "خلیل‌آباد",
        "خواف",
        "درگز",
        "رشتخوار",
        "زاوه",
        "سبزوار",
        "سرخس",
        "فریمان",
        "قوچان",
        "کاشمر",
        "کلات",
        "گناباد",
        "مه‌ولات",
        "نیشابور"
    ],
    "خراسان شمالی": [
        "بجنورد",
        "اسفراین",
        "جاجرم",
        "راز و جرگلان",
        "شیروان",
        "فاروج",
        "گرمه",
        "مانه و سملقان"
    ],
    "خوزستان": [
        "اهواز",
        "آبادان",
        "امیدیه",
        "اندیکا",
        "اندیمشک",
        "ایذه",
        "باغ‌ملک",
        "باوی",
        "بهبهان",
        "حمیدیه",
        "خرمشهر",
        "دزفول",
        "دشت آزادگان",
        "رامشیر",
        "رامهرمز",
        "شادگان",
        "شوش",
        "شوشتر",
        "کارون",
        "گتوند",
        "لالی",
        "ماهشهر",
        "مسجدسلیمان",
        "هفتکل",
        "هندیجان",
        "هویزه"
    ],
    "زنجان": [
        "زنجان",
        "ابهر",
        "ایجرود",
        "خدابنده",
        "خرمدره",
        "سلطانیه",
        "طارم",
        "ماهنشان"
    ],
    "سمنان": [
        "سمنان",
        "دامغان",
        "سرخه",
        "شاهرود",
        "گرمسار",
        "مهدی‌شهر",
        "میامی"
    ],
    "سیستان و بلوچستان": [
        "زاهدان",
        "ایرانشهر",
        "چابهار",
        "خاش",
        "دلگان",
        "زابل",
        "زهک",
        "سراوان",
        "سرباز",
        "سیب و سوران",
        "فنوج",
        "قصرقند",
        "کنارک",
        "مهرستان",
        "میرجاوه",
        "نیک‌شهر"
    ],
    "فارس": [
        "شیراز",
        "آباده",
        "ارسنجان",
        "استهبان",
        "اقلید",
        "بوانات",
        "پاسارگاد",
        "جهرم",
        "خرامه",
        "خنج",
        "داراب",
        "زرین‌دشت",
        "سروستان",
        "سپیدان",
        "شیراز",
        "فراشبند",
        "فسا",
        "فیروزآباد",
        "قایمیه",
        "قیر و کارزین",
        "کازرون",
        "گراش",
        "لارستان",
        "لامرد",
        "مرودشت",
        "ممسنی",
        "نی‌ریز"
    ],
    "قزوین": [
        "قزوین",
        "آبیک",
        "البرز",
        "بوئین‌زهرا",
        "تاکستان",
        "آوج"
    ],
    "قم": [
        "قم"
    ],
    "کردستان": [
        "سنندج",
        "بانه",
        "بیجار",
        "دیواندره",
        "دهگلان",
        "سروآباد",
        "سقز",
        "قروه",
        "کامیاران",
        "مریوان"
    ],
    "کرمان": [
        "کرمان",
        "ارزوئیه",
        "انار",
        "بافت",
        "بردسیر",
        "بم",
        "جیرفت",
        "رابر",
        "راور",
        "رودبار جنوب",
        "ریگان",
        "زرند",
        "سیرجان",
        "شهربابک",
        "عنبرآباد",
        "فاریاب",
        "فهرج",
        "قلعه گنج",
        "کوهبنان",
        "کهنوج",
        "منوجان"
    ],
    "کرمانشاه": [
        "کرمانشاه",
        "اسلام‌آباد غرب",
        "پاوه",
        "ثلاث باباجانی",
        "جوانرود",
        "دالاهو",
        "روانسر",
        "سرپل ذهاب",
        "سنقر",
        "صحنه",
        "قصر شیرین",
        "کرند غرب",
        "کنگاور",
        "گیلانغرب",
        "هرسین"
    ],
    "کهگیلویه و بویراحمد": [
        "یاسوج",
        "باشت",
        "بویراحمد",
        "بهمئی",
        "چرام",
        "دنا",
        "کهگیلویه",
        "گچساران",
        "لنده"
    ],
    "گلستان": [
        "گرگان",
        "آزادشهر",
        "آق‌قلا",
        "بندر گز",
        "ترکمن",
        "رامیان",
        "علی‌آباد کتول",
        "کردکوی",
        "کلاله",
        "گالیکش",
        "گمیشان",
        "گنبد کاووس",
        "مراوه‌تپه",
        "مینودشت"
    ],
    "گیلان": [
        "رشت",
        "آستارا",
        "آستانه اشرفیه",
        "املش",
        "بندر انزلی",
        "تالش",
        "رودبار",
        "رودسر",
        "رضوانشهر",
        "سیاهکل",
        "شفت",
        "صومعه‌سرا",
        "فومن",
        "لاهیجان",
        "لنگرود",
        "ماسال"
    ],
    "لرستان": [
        "خرم‌آباد",
        "الیگودرز",
        "بروجرد",
        "پل‌دختر",
        "چگنی",
        "دلفان",
        "دورود",
        "رومشکان",
        "سلسله",
        "کوهدشت"
    ],
    "مازندران": [
        "ساری",
        "آمل",
        "بابل",
        "بابلسر",
        "بهشهر",
        "تنکابن",
        "جویبار",
        "چالوس",
        "رامسر",
        "سوادکوه",
        "عباس‌آباد",
        "فریدون‌کنار",
        "قائم‌شهر",
        "کلاردشت",
        "گلوگاه",
        "محمودآباد",
        "میاندرود",
        "نکا",
        "نور",
        "نوشهر"
    ],
    "مرکزی": [
        "اراک",
        "آشتیان",
        "تفرش",
        "خمین",
        "دلیجان",
        "زرندیه",
        "ساوه",
        "شازند",
        "کمیجان",
        "محلات"
    ],
    "هرمزگان": [
        "بندرعباس",
        "ابوموسی",
        "بستک",
        "بشاگرد",
        "بندر لنگه",
        "پارسیان",
        "جاسک",
        "حاجی‌آباد",
        "خمیر",
        "رودان",
        "سیریک",
        "قشم",
        "میناب"
    ],
    "همدان": [
        "همدان",
        "اسدآباد",
        "بهار",
        "تویسرکان",
        "رزن",
        "کبودرآهنگ",
        "ملایر",
        "نهاوند"
    ],
    "یزد": [
        "یزد",
        "ابرکوه",
        "اردکان",
        "اشکذر",
        "بافق",
        "بهاباد",
        "تفت",
        "خاتم",
        "مهریز",
        "میبد"
    ]
};


document.addEventListener("DOMContentLoaded", function () {
    const provinceSelect = document.getElementById("province");
    const citySelect = document.getElementById("city");

    function updateCities() {
        const selectedProvince = provinceSelect.value;
        citySelect.innerHTML = '<option value="">انتخاب شهر</option>'; // پاک‌سازی لیست شهرها

        if (selectedProvince && citiesByProvince[selectedProvince]) {
            citiesByProvince[selectedProvince].forEach(city => {
                const option = document.createElement("option");
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
        }
    }

    // اجرای تابع هنگام تغییر استان
    provinceSelect.addEventListener("change", updateCities);

    // **حفظ مقدار شهر در صورت ویرایش محصول**
    if (provinceSelect.value) {
        updateCities(); // شهرها رو بارگذاری کن
        setTimeout(() => {
            citySelect.value = "{{ product.address.split('-')[1] if product else '' }}";
        }, 100); // تأخیر کوتاه برای اطمینان از لود کامل گزینه‌ها
    }
});

</script>

{% endblock %}
